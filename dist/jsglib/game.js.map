{"version":3,"sources":["../../jsglib/game.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;QAOqB,IAAI;kBAAJ,IAAI;;iBAAJ,IAAI;;;;kCAAJ,IAAI;;+EAAJ,IAAI;;;;;;;;;;;;;qBAAJ,IAAI;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;eAAJ,IAAI;;;sBAAJ,IAAI","file":"game.js","sourcesContent":["\"use strict\";\r\n\r\nimport Layer from 'jsglib/layer';\r\nimport Timer from 'jsglib/timer';\r\nimport EventsHandler from 'jsglib/events_handler';\r\nimport Inputs from 'jsglib/inputs';\r\n\r\nexport default class Game extends EventsHandler {\r\n    constructor(game_container, layers = [\r\n        Layer.MAIN_LAYER,\r\n        Layer.TILES_LAYER,\r\n        Layer.BACKGROUND_LAYER\r\n    ], fps = 30) {\r\n        super();\r\n        this.container = game_container;\r\n        this.current_room = null;\r\n        this.classes = {};\r\n        this.timer = new Timer(fps);\r\n\r\n        this.defineLayers(layers);\r\n        this.inputs = new Inputs(this.container);\r\n    }\r\n\r\n    defineLayers(layers) {\r\n        this.layers = {};\r\n\r\n        layers.reverse().forEach((layer, key) => {\r\n            layer.setZindex(key);\r\n            this.layers[layer.name] = layer;\r\n            this.container.appendChild(layer.canvas);\r\n        });\r\n\r\n        return this;\r\n    }\r\n\r\n    getLayerFromName(layer_name) {\r\n        return this.layers[layer_name];\r\n    }\r\n\r\n    registerClass(new_class) {\r\n        this.classes[new_class.name] = new_class;\r\n        return this;\r\n    }\r\n\r\n    getClass(class_name) {\r\n        if (typeof class_name === 'function') {\r\n            return class_name;\r\n        }\r\n\r\n        if (this.classes[class_name]) {\r\n            return this.classes[class_name];\r\n        }\r\n\r\n        return window[class_name];\r\n    }\r\n\r\n    start() {\r\n        this.last_loop_time = Date.now();\r\n        this.loop();\r\n        return this;\r\n    }\r\n\r\n    loop() {\r\n        window.requestAnimationFrame(this.loop.bind(this));\r\n\r\n        let now = Date.now();\r\n        let delta = now - this.last_loop_time;\r\n        let interval = 1000 / this.timer.fps;\r\n\r\n        if (delta <= interval) {\r\n            this.timer.trigger('frame');\r\n\r\n            return this;\r\n        }\r\n\r\n        this.manageElements();\r\n\r\n        this.render();\r\n\r\n        this.last_loop_time = now - (delta % interval);\r\n\r\n        return this;\r\n    }\r\n\r\n    manageElements() {\r\n        for (let layer_name in this.layers) {\r\n            let layer = this.layers[layer_name];\r\n\r\n            layer.elements.forEach((element) => {\r\n                element.trigger('frame');\r\n                element.move();\r\n\r\n                // Check collisions only if element has moved\r\n                if (!element.position.equals(element.prev_position)) {\r\n                    element.checkCollisions(this.layers);\r\n                }\r\n\r\n                if (!element.position.equals(element.prev_position)) {\r\n                    layer.needs_clear = true;\r\n                    element.prev_position.copy(element.position);\r\n                }\r\n            });\r\n        }\r\n\r\n        return this;\r\n    }\r\n\r\n    render() {\r\n        for (let layer_name in this.layers) {\r\n            let layer = this.layers[layer_name];\r\n            let force_redraw = false;\r\n\r\n            if (layer.needs_clear) {\r\n                layer.clear();\r\n                layer.needs_clear = false;\r\n                force_redraw = true;\r\n            }\r\n\r\n            layer.draw(force_redraw);\r\n        }\r\n\r\n        return this;\r\n    }\r\n\r\n    goToRoom(level) {\r\n        this.current_room = level;\r\n        level.initRoom(this);\r\n\r\n        this.container.style.width = level.width + 'px';\r\n        this.container.style.height = level.height + 'px';\r\n\r\n        for (let layer_name in this.layers) {\r\n            let layer = this.layers[layer_name];\r\n            layer.setSize(level.width, level.height);\r\n        }\r\n\r\n        level.trigger('start');\r\n\r\n        return this;\r\n    }\r\n}"]}